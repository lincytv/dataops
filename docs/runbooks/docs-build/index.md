---
layout: default
description: IBM Cloud Docs Build Overview
title: IBM Cloud docs build overview
service: armada-deploy
runbook-name: "IBM Cloud Docs Build"
tags: docs, build
link: /docs-build/index.html
type: Informational
---

## IBM Cloud Docs Build

## Purpose:
These instructions are for build admins who need to understand any tasks associated with building content

## Build overview

IBM Bluemix core team provides an end-to-end build experience for Bluemix documentation. Our goal is to take source stored Markdown, help writers/developers manage that source in Github, and provide dependable HTML 5 transformed content assembled together in a Knowledge-Center-consumable image, promoted up through Knowledge Center's normalization process where it is delivered into an entitled private staging collection and a public production collection that can be read from our Bluemix Doc App via KC REST APIs.

The Bluemix doc experience is broken into 3 pieces:
1. The Doc app
2. The doc-build-generated content, navigation, and search
3. The KC hosted GSA environment and KC REST APIs

### Bluemix Doc App microservice

The first part of the doc experience is the Bluemix doc app microservice. This is the framework through which content is both styled and delivered, search is provided and optimized, and navigation is assembled so that our content, search, and navigation look beautiful on the glass. The Bluemix doc builds do not include the Doc app microservice. The Microservice is a separate codebase, build, and deployment. For more on the doc app, see: **TBD Runbook**


### Bluemix doc-build-generated content, navigation, and search

The second part of the doc expereince is the content, navigation, and search that is generated by the doc build. For each subcollection of markdown content hosted in Github the build clones or downloads this content to a Virtual Machine, where it generates HTML5 content files, and toc.xml navigation files. Collections are then assembled together in a large super-set, and the Knowledge Center pre-builder code is used to normalize the super-set collection of all Bluemix staging or all Blumeix production content; HTML5 NL content is restructured, all of the navigation files are assembled into one giant toc.xml navigation file, and a search index is compiled. This content is then delivered to Knowledge Center's hosted GSA location where it is promoted up to their production environment as an entitled collection.

### KC hosted environment and KC REST APIs

The theird and final part of the doc experience is the KC hosted environment where the final image of generated content/navigation/search live, and the KC REST APIs that are used by the Doc app microservice to obtain the content/navigation/search it hosts on the glass (For example the KC /api/toc/ will transform the toc.xml super-set navigation file into a consumable JSON for the Doc app to consume and use to render the navigation). We provide KC with a `bluemix` production collection hosted in their KC GSA location, as well as a `bluemix_stage` staging collection hosted in their KC GSA location.
   * The Doc app hosted in https://console.stage1.bluemix.net/docs points to `bluemix_stage` collection hosted at https://a01gsa.ibm.com/projects/a/ahe01_kc/projects/www/content/knwctr/kc_normalized/bluemix_stage/ and registered through the following properties file: https://pokgsa.ibm.com/projects/a/ahe01_kc/projects/wwwtest/content/knwctr/cloud/_content_config/bluemix/bluemix_stage.properties
   * The Doc app hosted in https://console.bluemix.net/docs points to `bluemix` collection hosted at https://a01gsa.ibm.com/projects/a/ahe01_kc/projects/www/content/knwctr/kc_normalized/bluemix/ and registered through the following properties file: https://pokgsa.ibm.com/projects/a/ahe01_kc/projects/wwwtest/content/knwctr/cloud/_content_config/bluemix/bluemix.properties

## Technologies you should be aware of:

Assumption: The end-to-end build process requires both knowledge of, and access to, the following technologies:

* Jenkins
* Jenkins pipeline
* Github (GHE) (SSH)
* Functional IDs
* Slack
* REST APIs
   * KC REST APIS: content, toc, search, sitemap, session, suggest
   * Other?
* Code and scripting languages:
   * node.js
   * npm
   * Markdown
* Operating Systems:
   * Linux OS
* Docker
* Markdown HTML5 generator (tool)


## Jenkins Jobs used to build Bluemix content

The Bluemix documentation content, navigation, and search builds are compiled using scripts hosted in Github Enterprise, and these scripts are assembled and started, stopped, and scheduled using Jenkins jobs. All Jenkins jobs are here: https://bluemix-w3-jenkins.swg-devops.com:8443/

### Adding filtered views to find all jobs

There are many different jobs for staging, master, and poll jobs that listen for changes in content repositories, and kick off each component. There are more details later in this guide that walk through each job, but to get started, lets add custom views for each type of job:

#### Docs-staging view:

1. Click My Views
2. Name the job `Docs-staging`
3. Select list view and click OK.
4. Scroll down in the config window till you see `Use a regular expression to include jobs into the view`.
5. Enter the following value: `Docs-staging-.*`
6. Click OK, and you now see a list of jobs associated with Staging builds, which will dynamically refresh with any new staging jobs.


#### Docs-master view

1. Click My Views
2. Name the job `Docs-master`
3. Select list view and click OK.
4. Scroll down in the config window till you see `Use a regular expression to include jobs into the view`
5. Enter the following value: `Docs-master-.*`
6. Click OK, and you now see a list of jobs associated with Production builds, which will dynamically refresh with any new master jobs.


#### Docs-poll view

1. Click My Views
2. Name the job `Docs-poll`
3. Select list view and click OK.
4. Scroll down in the config window till you see `Use a regular expression to include jobs into the view`
5. Enter the following value: `Docs-poll-.*``
6. Click OK, and you now see a list of jobs associated with both prod and stage poll jobs which define each repo and where it builds to.


## Creating a new content sub-collection in our staging environment:

For each new collection of content added as a Bluemix offering we create a new private Github Enterprise repository. We have templates for adding these new repos that we follow to get them fully enabled. We also create public facing production Github repos. The steps to enable repos and their corresponding jobs are nearly equivalent. The primary difference is that the GHE jobs are enabled with a git plugin service that triggers the job when a commit is made to GHE. This does not work in Github, so the poll jobs enabled for production github repos just use a scheduled polling job that checks for changes every 15 minutes. For teams adopting our builds, you should evaluate what level of poll and git plugin service is supported for between Jenkins and the repository.

## Before you begin:
Make sure you know where to nest the collection. While most collections will live in `/services`, but the provider might expect them elsewhere. We use path values set in `poll` jobs to specify if the folder is nested within another folder.

Folders that have nested content controlled by build job path:
* /services
* /infrastructure
* /cli (plugins)
* /starters
* /runtimes

### Step 1: Create the Repo and set it up:

Create a new repo. For example, if Allen requests `/services/alchemy-language` you would go to the root of Jenkins: https://github.ibm.com/Bluemix-Docs and click **New**.  Next you would name the repo `alchemy-language`.

**Note:** do not add the `/services/` to the repo name - you will do this when you set up a build job for this new repo.

From your Github organization:

1. Click the green `New` repository button
   2. Add the **Repository name**. For example: `alchemy-language`.
   3. Add the name as the **Description**. For example: `alchemy-language`.
   4. Set to **Public**.
   5. Specify **Initialize this repository with a README**.
   6. Click **Create repository**.
2. Create a `staging` branch. Because our private GHE repos are set to build to our private internal version of the docs app we want to use `staging` as the default branch and remove the `master` branch.
   1. Click on the drop-down on the Branch button currently set to `master`.
   2. Type *staging*.
   3. Click **Create branch: staging**.
3. Set default branch to staging:
   1. Navigate to **Settings>Branches**.
   2. Under **Default branch** select *staging* and click **Update**.
4. Delete master branch:
   1. Click `branches` tab.
   2. Click the trash can icon next to the master branch.
5. Protect the `staging` branch
   1. Under **Settings>Branches>Protected Branches**
   2. Select Staging and:
       1. Specify **Protect this branch**
       2. Specify **Require pull request reviews before merging**
   3. Leave the rest unchecked and click **Save**.
6. Add collaborators:
   1. Navigate to **Settings>Collaborators** and **Teams>Collaborators**
   2. Add the collaborator GHE id, and click **Add collaborator**
   3. Specify the initial owner's permission level as **Admin** You can also add a team if requested.
7. Set the webhook to point to jenkins:
   1. Go to **Settings**
   2. Under the "Services" section in **Hooks & Services**, click **Add Service**
   3. Select `Jenkins (Git plugin)` for the service value.
   4. Add the root url value of Jenkins in the **Jenkins URL** field. For Bluemix we add: https://bluemix-w3-jenkins.swg-devops.com:8443
   5. Click **Add Service**


### Step 2: Enable a new polling job

In Step 1 you created the new internal Github Enterprise repository. Next you need to create a Jenkins poll job that will listen for any changes that will occur in the new repository.

1. Go to: https://bluemix-w3-jenkins.swg-devops.com:8443
2. From main Jenkins left-nav, click **+ New**.
3. Scroll down to **Create a new item from other existing**.
4. Find an existing polling job you want to copy - make sure it is a staging job. For example: I chose `Docs-poll-staging-appid`.
5. Scroll back up to the top and give the job a name. In my case, I copied in `Docs-poll-staging-appid` and changed it to `Docs-poll-staging-mass-data-migration`.
6. Click **OK**.
7. You are now in the configuration view. Scroll down to the **DIRECTORY** parameter and modify the value. In this case i modified `services/appid` > `services/mass-data-migration`.
8. Scroll down to **Source Code Management** and modify the **Repository URL**. In my case, I changed `git@github.ibm.com:Bluemix-Docs/appid.git` > `git@github.ibm.com:Bluemix-Docs/mass-data-migration.git`
9. Click SAVE.


### Step 3: Update the master navigation

The new subcollection you created will eventually have a `toc` file added to it. That file will generate an output `toc.xml` file during the build. The Bluemix overall navigation must point to this `toc.xml` file in order for it to be included.

1. Add the new toc.xml to the master control map: https://github.ibm.com/Bluemix-Docs/test/blob/staging/toc.xml

Location to be updated soon to real location.


## How to add a new subcollection to Production:

This repeats most of the steps you completed for enabling a Staging subcollection, only you will not need to change default branch, you will use master branch instead, you will not need a webhook, and instead you will set up polling on a schedule, and finally because you already enabled the master navigation for the staging subcollection, it will already be enabled for the production subcollection.


### Step 1: Create the public Repo and set it up:

Create a new repo out in Github, repeating most of what you did for your staging collection. For example, if Allen requests `/services/alchemy-language` you would go to the root of your Github Org: https://github.com/IBM-Bluemix-Docs/ and click **New**.  Next you would name the repo `alchemy-language`.

**Note:** do not add the `/services/` to the repo name - you will do this when you set up a build job for this new repo.

From your Github organization:

1. Click the green `New` repository button:
   2. Add the **Repository name**. For example: `alchemy-language`.
   3. Add the name as the **Description**. For example: `alchemy-language`.
   4. Set to **Public**.
   5. Specify **Initialize this repository with a README**.
   6. Click **Create repository**.
2. Protect the `master` branch (No need to create staging branch in production repo we use master):
   1. Under **Settings>Branches>Protected Branches**
   2. Select Staging and:
       1. Specify **Protect this branch**
       2. Specify **Require pull request reviews before merging**
   3. Leave the rest unchecked and click **Save**.
6. Add collaborators:
   1. Navigate to **Settings>Collaborators** and **Teams>Collaborators**
   2. Add the collaborator's public Github id, and click **Add collaborator**
   3. Specify the initial owner's permission level as **Admin** You can also add a team if requested.

**Note**: Webhooks to Jenkins do not work from public Jenkins, so you do not need to add the git service like you did when you enabled the staging repository.


### Step 2: Enable a new polling job

In Step 1 you created the new public Github repository. Next you need to create a Jenkins poll job that will run a scheduled check to see if any updates have been made to the new github repo.

1. Go to: https://bluemix-w3-jenkins.swg-devops.com:8443
2. From main Jenkins left-nav, click **+ New**.
3. Scroll down to **Create a new item from other existing**.
4. Find an existing polling job you want to copy - make sure it is a staging job. For example: I chose `Docs-poll-master-appid`.
5. Scroll back up to the top and give the job a name. In my case, I copied in `Docs-poll-master-appid` and changed it to `Docs-poll-master-mass-data-migration`.
6. Click **OK**.
7. You are now in the configuration view. Scroll down to the **DIRECTORY** parameter and modify the value. In this case i modified `services/appid` > `services/mass-data-migration`.
8. Scroll down to **Source Code Management** and modify the **Repository URL**. In my case, I changed `git@github.com:IBM-Bluemix-Docs/appid.git` > `git@github.com:IBM-Bluemix-Docs/mass-data-migration.git`
9. Click SAVE.

**Note**: The navigation was updated when you enabled the staging repos and jobs, there is no need to update the master navigation again, as your updates apply to both staging and production!



## Documentation content build scripts:

This repo has all scripts and control files used for the Bluemix doc builds: https://github.ibm.com/Bluemix/docs-build


### Markdown Build control files:

Location: https://github.ibm.com/Bluemix/docs-build/tree/master/markdown

**Description**: contains the scripts that clone, move, and transform our markdown sourced content.

   * `cloudoeconrefs.yml` is the YAML file that contains all our product names and is used by the markdown parser:  https://github.ibm.com/Bluemix/docs-build/blob/master/markdown/cloudoeconrefs.yml
   * `headers` contains all the different headers for all NLs and all Repos: https://github.ibm.com/Bluemix/docs-build/tree/master/markdown/headers
   * `Footer and Extensions` are the simple html footer that is applied to the bottom of each file. Also in here are several Extensions used by the parser: https://github.ibm.com/Bluemix/docs-build/tree/master/markdown

### Normalization Build Control files:

Location: https://github.ibm.com/Bluemix/docs-build/tree/master/kc-prebuild

**Description**: This directory contains the latest KC prebuilder used for normalizing content. This code does the following things:

   * Unzips any doc.zip content
   * Rearanges NL structure
   * Assembles all subcollection navigation xml files and creates a navigation toc.xml.gz file for every language
   * creates a search index for every language

### KC Build Control files:

Location: https://pokgsa.ibm.com/projects/a/ahe01_kc/projects/wwwtest/content/knwctr/cloud/_content_config/bluemix/

This location contains our two primary collection properties files:

   * bluemix.properties
   * bluemix_stage.properties

**Description**: Each collection has its own set of control values that allows KC to pull norm content in and promote up their stack. The values in these files are critical and if there is a break you should content Chee O Wai.

**For example:**
```
product=bluemix_stage
path=../../bluemix/bluemix_staging
toc=navigation/cloudoe.ditamap
isEntitled=yes
cloud.indexable.attributes=subcollection
cloud.enabled=true
normalized.git.url=git@github.ibm.com:Bluemix-Docs/docs-build-output.git
normalized.git.branch=bluemix_stage
```

### KC taxonomy record.

In order to promote a content collection to KC production, each collection must have a KC record, and a unique KC taxonomy key. The KC record is managed in the KC Life Cycle DB in IBM Notes.

Bluemix Records:
   * `bluemix`: Notes://D01DBR12/86256C4E00661DF8/F6C9372282E8500C85257DE9005E38EA/5C2DE0C0E11FA64085258068006A4ADB 
   * `bluemix_stage`: Notes://D01DBR12/86256C4E00661DF8/F6C9372282E8500C85257DE9005E38EA/C6B5694BFB9A290A85258067007CA052 


These records are managed and maintained by the KC Cloud brand administrator: Sebastian Fuhrer
