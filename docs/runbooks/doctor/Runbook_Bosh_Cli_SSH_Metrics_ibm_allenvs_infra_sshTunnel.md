---
layout: default
description: The BOSH SSH Client may get disconnected by a firewall. Self-healing can restore automatically, but sometimes it needs to be recovered manually.
title: "BoshCli SSH Metrics ibm.allenvs.infra.sshTunnel"
service: bosh_cli_ssh
runbook-name: "Bosh Cli SSH Metrics_ibm_allenvs_infra_sshTunnel"
tags: oss, bluemix, BoshCLI, bosh_cli_ssh, bosh, cli, ssh
link: /doctor/Runbook_Bosh_Cli_SSH_Metrics_ibm_allenvs_infra_sshTunnel.html
type: Alert
---

{% include {{site.target}}/load_oss_doctor_constants.md %}
{% include {{site.target}}/load_oss_slack_constants.md %}
{% include {{site.target}}/load_ghe_constants.md %}
{% include {{site.target}}/load_oss_contacts_constants.md %}
{% include {{site.target}}/new_relic_tip.html%}
__

## Purpose
This alert will be triggered if the BOSH client SSH can not connected.

## Technical Details
BOSH SSH Client is a native SSH connection. Each dedicated/local tenant has this job in a BOSH client VM server. It creates an SSH tunnel to {{doctor-hub-name}} ({{doctor-hub-ip}}).

The BOSH client SSH may get disconnected by a firewall. Our program can restore automatically, but sometimes it may need to be recovered manually.

Grafana shows the status of the SSH Tunnel for all environments at [{{grafana-dashboard-name}}]({{grafana-dashboard-link}}).  Select the specific environment to isolate it's status and filter out all other environments.

## User Impact
User can not connect to the BOSH client SSH from intranet bosh cli, but from Doctor page, SSH is working

## Instructions to Fix

### When an alert is received:


1. Verify that the tunnel is in fact down by following the `How to use` steps in the [Doctor SSH Jumpbox]({{site.baseurl}}/docs/runbooks/doctor/Doctor_SSH_Jumpbox.html) document.

    - If you can successfully login, the tunnel is up and running and the alert can be resolved. Since the tunnel is up and we are receiving the alert. You may need to take further step to verify if the alert is false positive:
      * Open the PagerDuty incident and check the port number from the incident details, for example:
            `st_sshtunnel_down(60009):D_CIO:internal:dedicated::us-south`
            where the `60009` is the port is monitored and send alert.
      * Check the port number from jumpbox script, for example run following command on jumpbox:
            `<your-intranet-id>@bosh-cli-bluemix-new:~/bin$ cat boshcli_d_cio.sh`
        you will see the port setting from the script:


            #!/bin/bash
            # This file is automatically generated. Creation date : 2018-07-03 10:23:57

            #set -x

            ### Global variables
            JUMPBOX=9.66.243.81
            PORT=60009


        if the port in Jumpbox script is different from the port reported on PagerDuty incident, it means the monitor tool is monitoring wrong port number to check the SSH tunnel status. Find the port number using [How to create a missing environment script for Jumbox]({{site.baseurl}}/docs/runbooks/doctor/Doctor_Oncall_Tips_and_Techniques.html#how-to-create-a-missing-environment-script-for-jumbox). If need more help contact the on call for Doctor team at the slack channel [{{oss-doctor-name}}]({{oss-doctor-link}}) and report the situation.          

    - If you can not login to the jumpbox, the tunnel is down and you should check whether the password has expired, and if so, [change the password]({{site.baseurl}}/docs/runbooks/doctor/Doctor_Oncall_Tips_and_Techniques.html#password-expired), otherwise continue to the next step.

2. SSH to BOSH client VM. Login in using your SSO username and password. **If you can't logging using your SSO ID, try firecall ID**, for more info how to get a firecal ID go [here]({{site.baseurl}}/docs/runbooks/doctor/ibm-only/Doctor_ops_access_an_environment_to_execute_runbook_commands.html)
    - **LAST RESORT ONLY:** If you have trouble logging in using your SSO username or a firecall ID.
    - If you receive a `ssh: connect to host {%if site.target == 'ibm' %} 10.x.x.x port 22: {% else %} XX.x.x.x port 22 {% endif %} No route to host` error messageï¼Œ Slack GRE oncall at #sre-platform-shift, ask help to check the system status or reboot it.   **(It's risky to reboot without GRE permission, and will cause cloud env interrupted  )**
      > 1. Navigate to [{{doctor-portal-name}}]({{doctor-portal-link}}).
      > 2. User the Search field to find the environment.
      > 3. Click on the selected environment.
      > ![]({{site.baseurl}}/docs/runbooks/doctor/images/bosh-cli-ssh/no_route_to_host_1.png)
      > 4. Under **Details**.
      > 5. Move to **IaaS** tab.
      > 6. Find the **BOSH CLI VM**.
      > 7. Select the **three vertical dots** on the far right of the **BOSH CLI VM**
      > 8. Click on **Hard Restart Server**. After the restart try logging in again.
      > ![]({{site.baseurl}}/docs/runbooks/doctor/images/bosh-cli-ssh/no_route_to_host_2.png)

3. `sudo -i` on the BOSH client VM to switch to root.
4. For dedicated environments only. (**Do not change this setting in any Public or Local env.**)
    - Check the mtu first by `ifconfig eth0`.
    - The mtu should be 1300.
    - If it's not 1300, update the mtu manually by running `ifconfig eth0 mtu 1300`.
5. Determine if the job _bosh_cli_ssh_ runs under supervisorctl, or as a docker container:

    > **Note:** If the alert is from Lacaixa, ignore below steps. ssh tunnel service is started via docker instead of supervisor task  , check nat ip using command `ps -ef |grep sshhub |grep doctor_blink`, then run nc command to check if network is accessible .  

      ```
      supervisorctl status | grep bosh_cli_ssh
      #   or
      docker ps -a | grep bosh_cli_ssh
      ```

    - One of the above commands should return some value.
      - If you get `unix:///var/run/supervisor.sock refused connection` when running `supervisorctl status` go to step 9.
      - If _bosh_cli_ssh_ runs under supervisorctl, go to step 7.
      - If _bosh_cli_ssh_ runs as a docker container, go to the next step.

5. (_bosh_cli_ssh_ runs as a docker container) Run:
     ```
     supervisorctl restart bosh_cli_ssh
     # or
     docker restart bosh_cli_ssh
     ```  
   Go to step 10.
7. (_bosh_cli_ssh_ runs under supervisorctl)
   - For local/dedicated bluemix run the command:
     `nc {{netcat-ip-local}} {{netcat-port-local}} -w 3`   
   - For public bluemix run the command:
     `nc {{netcat-ip-public}} {{netcat-port-public}} -w 3`   
   - And then run:
     `echo $?`    
9. If `echo $?` returns 1, that means this server can not connect to the Doctor SSH Hub. However, this may be an intermittent network problem, so wait 5 minutes and try to run the `nc` command again.If the `nc` command still returns 1, contact the network team or open a defect against them
stating that OpenVPN to the environment is not working.  To find who is on call for the network team, go to the <img width='14' height='14' alt='Slack' style='vertical-align:text-top ;border:none;' border='0' src='{{site.baseurl}}/docs/runbooks/images/slack/slack-icon.jpeg'/> [{{sre-platform-onshift-name}}]({{sre-platform-onshift-link}}) and type `@cybot whos on call network`.

10. If `echo $?` returns 0, that means the current SSH tunnel was blocked by firewall.We need restore it manually by running `supervisorctl restart bosh_cli_ssh`.
  - If you receive a `unix:///var/run/supervisor.sock refused connection` or `unix:///var/run/supervisor.sock no such file` error when running the command, it's possible that the supervisord process is not running (this can be verified by running: `ps -A | grep super` ). ( Putting the grep search value in quotes doesn't work. e.g.  `ps -A | grep "super"` ) To manually start the supervisord process, run the following command:
`supervisord -c /etc/supervisor/supervisord.conf` or `service supervisor restart`
  - If you receive the *FAILED: attempted to kill bosh_cli_ssh with sig SIGTERM but it wasn't running bosh_cli_ssh: ERROR (no such file)* error when running the command, the BOSH client VM / inception VM may have been rebuilt or cleaned and no longer contains the needed Doctor code. Typically, {{doctor-ucd-name-A0215}} process will need to be re-run on the environment by the environment's SRE.  Contact <img width='14' height='14' alt='Slack' style='vertical-align:text-top ;border:none;' border='0' src='{{site.baseurl}}/docs/runbooks/images/slack/slack-icon.jpeg'/> [{{sre-platform-onshift-name}}]({{sre-platform-onshif-link}}). {% if site.target == "ibm" %}(see [Instruction - {{doctor-ucd-name-A0215}} - Deploy Doctor SSH]({{doctor-ucd-link}})) {% endif %}
  - For public/staging environment, If `/home/doctor/bosh_cli_ssh.sh` was missing, the UCD process [A2603:Re-deploy doctor SSH tunnel script] should be run.

11. If you have account in {{bosh-cli-link}}, you can login to this server and verify by running `boshcli_<env>.sh`
  - If you receive a **Connection refused** error when running the `boshcli_<env>.sh` script, try to run the follow command:
    - `nc -zvn <JUMPBOX_IP> <PORT>`, where **JUMPBOX_IP** and **PORT** from step 2. e.g. `nc -zvn 9.66.243.81 62069` if you also get "Connection refused" you will need to contact the network team for help.


## Notes and Special Considerations

{% include {{site.target}}/tips_and_techniques.html %}
